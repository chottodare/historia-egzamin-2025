<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Historyczny</title>
    
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .hidden { display: none; }
        body { transition: background-color 0.3s, color 0.3s; }
        /* === POCZƒÑTEK STYLI DO ANIMACJI === */

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-up {
  /* U≈ºywamy zdefiniowanej animacji */
  animation: fadeInUp 0.5s ease-out forwards;
}

/* Klasa pomocnicza do ukrywania element√≥w przed animacjƒÖ */
.opacity-0 {
    opacity: 0;
}

/* === KONIEC STYLI DO ANIMACJI === */
    </style>
    
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div id="app-container" class="p-4 sm:p-6 flex items-start justify-center min-h-screen">
        <div class="max-w-2xl w-full">
            
            <div id="quiz-view" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold flex items-center text-gray-800 dark:text-white">
                            <i data-lucide="book-open" class="mr-3 text-blue-500"></i>
                            <span id="quiz-title">Quiz Historyczny</span>
                        </h1>
                        <div class="flex items-center gap-4">
                            <button id="dark-mode-toggle-quiz" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                                <i data-lucide="sun" class="sun-icon"></i>
                                <i data-lucide="moon" class="moon-icon hidden"></i>
                            </button>
                            <div id="question-counter" class="text-sm text-gray-600 dark:text-gray-400">Pytanie 1 z X</div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <div class="rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-gray-600 dark:text-gray-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Statystyki og√≥lne:</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div id="overall-stats-display" class="text-sm text-gray-600 dark:text-gray-400">0/0 (0%)</div>
                                <button id="details-btn-quiz" class="text-sm underline text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                    Szczeg√≥≈Çy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 id="question-text" class="text-xl font-semibold mb-6 text-gray-800 dark:text-white">≈Åadowanie pytania...</h2>
                    <div id="options-container" class="space-y-3 mb-6"></div>
                    <div id="explanation-container" class="hidden"></div>

                    <div class="flex justify-end">
                        <button id="check-answer-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700">
                            Sprawd≈∫ odpowied≈∫ <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="completed-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                 <div class="flex justify-end mb-4">
                    <button id="dark-mode-toggle-completed" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                       <i data-lucide="sun" class="sun-icon"></i>
                       <i data-lucide="moon" class="moon-icon hidden"></i>
                    </button>
                 </div>
                 <div class="text-center">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 id="completed-title" class="text-3xl font-bold mb-4 text-gray-800 dark:text-white">Quiz uko≈Ñczony!</h2>
                    <div class="rounded-lg p-6 mb-6 bg-blue-50 dark:bg-blue-900/30">
                       <h3 class="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-400">Wyniki tego quizu:</h3>
                       <div class="grid grid-cols-2 gap-4 text-center mb-4">
                          <div class="rounded-lg p-4 bg-white dark:bg-gray-700">
                             <div id="current-score" class="text-2xl font-bold text-green-600 dark:text-green-400">0</div>
                             <div class="text-sm text-gray-600 dark:text-gray-400">Poprawne</div>
                          </div>
                          <div class="rounded-lg p-4 bg-white dark:bg-gray-700">
                             <div id="current-accuracy" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0%</div>
                             <div class="text-sm text-gray-600 dark:text-gray-400">Dok≈Çadno≈õƒá</div>
                          </div>
                       </div>
                    </div>
                    <div id="wrong-answers-summary" class="hidden rounded-lg p-4 mb-6 bg-red-50 dark:bg-red-900/20">
                       <h4 class="text-lg font-semibold mb-3 flex items-center justify-center text-red-800 dark:text-red-400">
                          <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                          B≈Çƒôdne odpowiedzi w tym quizie:
                       </h4>
                       <div id="wrong-answers-list" class="space-y-2 text-left max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3">
                       <button id="new-quiz-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center">
                          <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Nowy quiz
                       </button>
                       <button id="retake-wrong-btn-completed" class="hidden bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center">
                          <i data-lucide="target" class="w-4 h-4 mr-2"></i>Quiz z b≈Çƒôdnych pyta≈Ñ
                       </button>
                       <button id="details-btn-completed" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center">
                          <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i>Szczeg√≥≈Çowe statystyki
                       </button>
                    </div>
                 </div>
            </div>

            <div id="stats-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Szczeg√≥≈Çowe statystyki</h2>
                  <div class="flex items-center gap-2">
                    <button id="dark-mode-toggle-stats" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                       <i data-lucide="sun" class="sun-icon"></i>
                       <i data-lucide="moon" class="moon-icon hidden"></i>
                    </button>
                    <button id="back-to-quiz-btn" class="px-4 py-2 rounded-lg transition-colors text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
                      ‚Üê Powr√≥t
                    </button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div class="rounded-lg p-4 bg-blue-50 dark:bg-blue-900/30">
                    <div id="stats-total-quizzes" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Uko≈Ñczonych quiz√≥w</div>
                  </div>
                  <div class="rounded-lg p-4 bg-green-50 dark:bg-green-900/30">
                    <div id="stats-correct-answers" class="text-2xl font-bold text-green-600 dark:text-green-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Poprawnych odpowiedzi</div>
                  </div>
                  <div class="rounded-lg p-4 bg-red-50 dark:bg-red-900/30">
                    <div id="stats-wrong-questions-count" class="text-2xl font-bold text-red-600 dark:text-red-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">B≈Çƒôdnych pyta≈Ñ</div>
                  </div>
                </div>
                <div id="retake-section-stats" class="hidden mb-8">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Pytania do powt√≥rzenia</h3>
                    <button id="retake-wrong-btn-stats" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm flex items-center">
                      <i data-lucide="target" class="w-4 h-4 mr-2"></i>Quiz z b≈Çƒôdnych pyta≈Ñ
                    </button>
                  </div>
                  <div id="wrong-questions-details-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Historia quiz√≥w (ostatnie 10)</h3>
                    <div id="quiz-history-list" class="space-y-3"></div>
                </div>
                <div class="flex flex-wrap gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                  <button id="download-stats-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>Pobierz statystyki
                  </button>
                  <button id="reset-all-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>Wyczy≈õƒá wszystkie dane
                  </button>
                </div>
            </div>

        </div>
    </div>

    <script src="questions.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            transition: background-color 0.3s, color 0.3s; 
            font-family: 'Inter', sans-serif;
        }
        .hidden { display: none; }

        /* === POCZƒÑTEK STYLI MODALA === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .dark .modal-content {
            background-color: #1f2937; /* dark:bg-gray-800 */
        }
        /* === KONIEC STYLI MODALA === */

        /* === POCZƒÑTEK STYLI DO ANIMACJI (POPRAWKA) === */
        @keyframes elegantFadeInUp {
          from {
            opacity: 0;
            transform: translateY(10px) scale(0.98);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }

        .animate-elegant-fade-in-up {
          animation: elegantFadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        /* === KONIEC STYLI DO ANIMACJI === */

        .opacity-0 {
            opacity: 0;
        }
    </style>
    
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app-container" class="p-4 sm:p-6 flex items-start justify-center min-h-screen">
        <div class="max-w-2xl w-full">
            
            <!-- ### WIDOK QUIZU ### -->
            <div id="quiz-view" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold flex items-center text-gray-800 dark:text-white">
                            <i data-lucide="book-open" class="mr-3 text-blue-500"></i>
                            <span id="quiz-title">Quiz Historyczny</span>
                        </h1>
                        <div class="flex items-center gap-4">
                            <button id="dark-mode-toggle-quiz" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                                <i data-lucide="sun" class="sun-icon"></i>
                                <i data-lucide="moon" class="moon-icon hidden"></i>
                            </button>
                            <div id="question-counter" class="text-sm text-gray-600 dark:text-gray-400">Pytanie 1 z X</div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <div class="rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-gray-600 dark:text-gray-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Statystyki og√≥lne:</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div id="overall-stats-display" class="text-sm text-gray-600 dark:text-gray-400">0/0 (0%)</div>
                                <button id="details-btn-quiz" class="text-sm underline text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                    Szczeg√≥≈Çy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 id="question-text" class="text-xl font-semibold mb-6 text-gray-800 dark:text-white min-h-[56px]">≈Åadowanie pytania...</h2>
                    <div id="options-container" class="space-y-3 mb-6"></div>
                    <div id="explanation-container" class="hidden"></div>

                    <div class="flex justify-end">
                        <button id="check-answer-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700">
                            Sprawd≈∫ odpowied≈∫ <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ### WIDOK UKO≈ÉCZENIA ### -->
            <div id="completed-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                 <div class="flex justify-end mb-4">
                    <button id="dark-mode-toggle-completed" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                       <i data-lucide="sun" class="sun-icon"></i>
                       <i data-lucide="moon" class="moon-icon hidden"></i>
                    </button>
                 </div>
                 <div class="text-center">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h2 id="completed-title" class="text-3xl font-bold mb-4 text-gray-800 dark:text-white">Quiz uko≈Ñczony!</h2>
                    <div class="rounded-lg p-6 mb-6 bg-blue-50 dark:bg-blue-900/30">
                       <h3 class="text-xl font-semibold mb-4 text-blue-800 dark:text-blue-400">Wyniki tego quizu:</h3>
                       <div class="grid grid-cols-2 gap-4 text-center mb-4">
                          <div class="rounded-lg p-4 bg-white dark:bg-gray-700">
                             <div id="current-score" class="text-2xl font-bold text-green-600 dark:text-green-400">0</div>
                             <div class="text-sm text-gray-600 dark:text-gray-400">Poprawne</div>
                          </div>
                          <div class="rounded-lg p-4 bg-white dark:bg-gray-700">
                             <div id="current-accuracy" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0%</div>
                             <div class="text-sm text-gray-600 dark:text-gray-400">Dok≈Çadno≈õƒá</div>
                          </div>
                       </div>
                    </div>
                    <div id="wrong-answers-summary" class="hidden rounded-lg p-4 mb-6 bg-red-50 dark:bg-red-900/20">
                       <h4 class="text-lg font-semibold mb-3 flex items-center justify-center text-red-800 dark:text-red-400">
                          <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
                          B≈Çƒôdne odpowiedzi w tym quizie:
                       </h4>
                       <div id="wrong-answers-list" class="space-y-2 text-left max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3">
                       <button id="new-quiz-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center">
                          <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Nowy quiz
                       </button>
                       <button id="retake-wrong-btn-completed" class="hidden bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center">
                          <i data-lucide="target" class="w-4 h-4 mr-2"></i>Quiz z b≈Çƒôdnych pyta≈Ñ
                       </button>
                       <button id="details-btn-completed" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium flex items-center">
                          <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i>Szczeg√≥≈Çowe statystyki
                       </button>
                    </div>
                 </div>
            </div>

            <!-- ### WIDOK STATYSTYK ### -->
            <div id="stats-view" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Szczeg√≥≈Çowe statystyki</h2>
                  <div class="flex items-center gap-2">
                    <button id="dark-mode-toggle-stats" class="p-2 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-yellow-400">
                       <i data-lucide="sun" class="sun-icon"></i>
                       <i data-lucide="moon" class="moon-icon hidden"></i>
                    </button>
                    <button id="back-to-quiz-btn" class="px-4 py-2 rounded-lg transition-colors text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
                       ‚Üê Powr√≥t
                    </button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div class="rounded-lg p-4 bg-blue-50 dark:bg-blue-900/30">
                    <div id="stats-total-quizzes" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Uko≈Ñczonych quiz√≥w</div>
                  </div>
                  <div class="rounded-lg p-4 bg-green-50 dark:bg-green-900/30">
                    <div id="stats-correct-answers" class="text-2xl font-bold text-green-600 dark:text-green-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Poprawnych odpowiedzi</div>
                  </div>
                  <div class="rounded-lg p-4 bg-red-50 dark:bg-red-900/30">
                    <div id="stats-wrong-questions-count" class="text-2xl font-bold text-red-600 dark:text-red-400">0</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">B≈Çƒôdnych pyta≈Ñ</div>
                  </div>
                </div>
                <div id="retake-section-stats" class="hidden mb-8">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Pytania do powt√≥rzenia</h3>
                    <button id="retake-wrong-btn-stats" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm flex items-center">
                       <i data-lucide="target" class="w-4 h-4 mr-2"></i>Quiz z b≈Çƒôdnych pyta≈Ñ
                    </button>
                  </div>
                  <div id="wrong-questions-details-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Historia quiz√≥w (ostatnie 10)</h3>
                    <div id="quiz-history-list" class="space-y-3"></div>
                </div>
                <div class="flex flex-wrap gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                  <button id="download-stats-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>Pobierz statystyki
                  </button>
                  <button id="reset-all-data-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>Wyczy≈õƒá wszystkie dane
                  </button>
                </div>
            </div>

        </div>
    </div>
    
    <!-- ### MODAL POTWIERDZENIA ### -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Czy jeste≈õ pewien?</h3>
            <p id="modal-text" class="text-gray-600 dark:text-gray-400 mb-6">Tej operacji nie mo≈ºna cofnƒÖƒá.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500">Anuluj</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Potwierd≈∫</button>
            </div>
        </div>
    </div>

    <!-- ### DANE PYTA≈É ### -->
    <script>
        const allAvailableQuestions = [
            { id: 1, question: "W kt√≥rym roku odby≈Ça siƒô Bitwa pod Grunwaldem?", options: ["1410", "1525", "1683", "1331"], correct: 0, explanation: "Bitwa pod Grunwaldem, jedna z najwiƒôkszych bitew w historii ≈õredniowiecznej Europy, mia≈Ça miejsce 15 lipca 1410 roku." },
            { id: 2, question: "Kto by≈Ç pierwszym kr√≥lem Polski?", options: ["Mieszko I", "Kazimierz Wielki", "Boles≈Çaw Chrobry", "W≈Çadys≈Çaw Jagie≈Ç≈Ço"], correct: 2, explanation: "Boles≈Çaw Chrobry zosta≈Ç koronowany na pierwszego kr√≥la Polski w 1025 roku." },
            { id: 3, question: "Kt√≥re miasto by≈Ço pierwszƒÖ stolicƒÖ Polski?", options: ["Krak√≥w", "Warszawa", "Pozna≈Ñ", "Gniezno"], correct: 3, explanation: "Gniezno jest uwa≈ºane za pierwszƒÖ, historycznƒÖ stolicƒô Polski i kolebkƒô pa≈Ñstwa polskiego." },
            { id: 4, question: "W kt√≥rym roku Polska odzyska≈Ça niepodleg≈Ço≈õƒá po I wojnie ≈õwiatowej?", options: ["1914", "1918", "1920", "1921"], correct: 1, explanation: "Polska odzyska≈Ça niepodleg≈Ço≈õƒá 11 listopada 1918 roku, po 123 latach zabor√≥w." },
            { id: 5, question: "Kto by≈Ç autorem 'Pana Tadeusza'?", options: ["Henryk Sienkiewicz", "Adam Mickiewicz", "Juliusz S≈Çowacki", "Boles≈Çaw Prus"], correct: 1, explanation: "Adam Mickiewicz, jeden z Trzech Wieszcz√≥w, jest autorem epopei narodowej 'Pan Tadeusz'." }
        ];
    </script>

    <script>
        // ### STAN APLIKACJI (Zmienne globalne) ###
        const state = {
            currentQuestionIndex: 0,
            selectedAnswer: null,
            showExplanation: false,
            stats: { correct: 0, total: 0 },
            allQuizzes: [],
            wrongQuestions: [],
            isRetakeMode: false,
            darkMode: false,
            quizQuestions: [],
            currentQuizResults: [],
            currentView: 'quiz',
            isQuestionNewlyRendered: true // Flaga do kontroli animacji
        };

        // ### REFERENCJE DO ELEMENT√ìW DOM ###
        const quizView = document.getElementById('quiz-view');
        const completedView = document.getElementById('completed-view');
        const statsView = document.getElementById('stats-view');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounter = document.getElementById('question-counter');
        const quizTitle = document.getElementById('quiz-title');
        const explanationContainer = document.getElementById('explanation-container');
        const overallStatsDisplay = document.getElementById('overall-stats-display');
        const confirmationModal = document.getElementById('confirmation-modal');

        // ### FUNKCJE POMOCNICZE ###
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function saveData() {
            localStorage.setItem('quizStats', JSON.stringify(state.stats));
            localStorage.setItem('allQuizzes', JSON.stringify(state.allQuizzes));
            localStorage.setItem('wrongQuestions', JSON.stringify(state.wrongQuestions));
        }

        function loadData() {
            state.stats = JSON.parse(localStorage.getItem('quizStats') || '{"correct": 0, "total": 0}');
            state.allQuizzes = JSON.parse(localStorage.getItem('allQuizzes') || '[]');
            state.wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions') || '[]');
            state.darkMode = JSON.parse(localStorage.getItem('darkMode') || 'false');
        }
        
        function showConfirmationModal(callback) {
            confirmationModal.classList.add('active');
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const confirmHandler = () => {
                callback(true);
                hideConfirmationModal();
            };
            const cancelHandler = () => {
                callback(false);
                hideConfirmationModal();
            };
            
            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }

        function hideConfirmationModal() {
            confirmationModal.classList.remove('active');
        }

        // ### G≈Å√ìWNA LOGIKA APLIKACJI ###
        function handleAnswer() {
            if (state.selectedAnswer === null) return;
            state.showExplanation = true;
            const currentQ = state.quizQuestions[state.currentQuestionIndex];
            const isCorrect = parseInt(state.selectedAnswer) === currentQ.correct;

            state.currentQuizResults.push({
                questionId: currentQ.id,
                question: currentQ.question,
                options: currentQ.options,
                correctAnswer: currentQ.correct,
                userAnswer: parseInt(state.selectedAnswer),
                isCorrect: isCorrect,
                explanation: currentQ.explanation
            });
            
            if (!state.isRetakeMode) {
              state.stats.total++;
              if(isCorrect) state.stats.correct++;
            }

            let updatedWrongQuestions = [...state.wrongQuestions];
            const existingWrongIndex = updatedWrongQuestions.findIndex(wq => wq.id === currentQ.id);

            if (isCorrect) {
                if (existingWrongIndex > -1) {
                    updatedWrongQuestions.splice(existingWrongIndex, 1);
                }
            } else {
                if (existingWrongIndex === -1) {
                    updatedWrongQuestions.push({ ...currentQ, wrongCount: 1 });
                } else {
                    updatedWrongQuestions[existingWrongIndex].wrongCount++;
                }
            }
            state.wrongQuestions = updatedWrongQuestions;
            saveData();
            render();
        }

        function nextQuestion() {
            if (state.currentQuestionIndex < state.quizQuestions.length - 1) {
                state.currentQuestionIndex++;
                state.selectedAnswer = null;
                state.showExplanation = false;
                state.isQuestionNewlyRendered = true; // POPRAWKA: Ustaw flagƒô dla nowego pytania
                render();
            } else {
                completeQuiz();
            }
        }

        function completeQuiz() {
            const quizData = {
                id: Date.now(),
                date: new Date().toISOString(),
                results: state.currentQuizResults,
                score: state.currentQuizResults.filter(r => r.isCorrect).length,
                total: state.currentQuizResults.length,
                isRetake: state.isRetakeMode
            };
            state.allQuizzes.push(quizData);
            saveData();
            state.currentView = 'completed';
            render();
        }

        function resetQuiz(isRetake = false) {
            state.currentView = 'quiz';
            state.currentQuestionIndex = 0;
            state.selectedAnswer = null;
            state.showExplanation = false;
            state.currentQuizResults = [];
            state.isQuestionNewlyRendered = true; // POPRAWKA: Ustaw flagƒô dla nowego pytania

            if(isRetake && state.wrongQuestions.length > 0) {
                state.isRetakeMode = true;
                state.quizQuestions = shuffleArray([...state.wrongQuestions]);
            } else {
                state.isRetakeMode = false;
                state.quizQuestions = shuffleArray([...allAvailableQuestions]).slice(0, 5);
            }
            render();
        }
        
        function resetAllData() {
            showConfirmationModal(confirmed => {
                if (confirmed) {
                    state.stats = { correct: 0, total: 0 };
                    state.allQuizzes = [];
                    state.wrongQuestions = [];
                    saveData();
                    resetQuiz();
                }
            });
        }

        function downloadStats() {
            const statsData = {
                overallStats: state.stats,
                allQuizzes: state.allQuizzes,
                wrongQuestions: state.wrongQuestions,
                exportDate: new Date().toISOString()
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(statsData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `quiz-stats-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', JSON.stringify(state.darkMode));
            renderDarkMode();
        }
        
        // ### FUNKCJE RENDERUJƒÑCE ###
        function renderDarkMode() {
             document.documentElement.classList.toggle('dark', state.darkMode);
             document.querySelectorAll('.sun-icon').forEach(i => i.classList.toggle('hidden', state.darkMode));
             document.querySelectorAll('.moon-icon').forEach(i => i.classList.toggle('hidden', !state.darkMode));
        }

        function renderQuizView() {
            const questionEl = document.getElementById('question-text');
            const optionsEl = document.getElementById('options-container');

            const applyAnimation = state.isQuestionNewlyRendered; // Sprawd≈∫ flagƒô przed op√≥≈∫nieniem
            
            if (applyAnimation) {
                questionEl.classList.add('opacity-0');
                optionsEl.classList.add('opacity-0');
            }

            setTimeout(() => {
                const currentQ = state.quizQuestions[state.currentQuestionIndex];
                if(!currentQ) {
                    // ... (obs≈Çuga braku pyta≈Ñ)
                    return;
                }
                
                checkAnswerBtn.classList.remove('hidden');
                quizTitle.textContent = state.isRetakeMode ? `Quiz Historyczny (Powt√≥rka)` : 'Quiz Historyczny';
                questionText.textContent = currentQ.question;
                questionCounter.textContent = `Pytanie ${state.currentQuestionIndex + 1} z ${state.quizQuestions.length}`;
                progressBar.style.width = `${((state.currentQuestionIndex) / state.quizQuestions.length) * 100}%`;
                
                optionsContainer.innerHTML = '';
                currentQ.options.forEach((option, index) => {
                    const isSelected = state.selectedAnswer !== null && parseInt(state.selectedAnswer) === index;
                    const isCorrect = state.showExplanation && index === currentQ.correct;
                    const isWrong = state.showExplanation && isSelected && index !== currentQ.correct;
                    
                    // POPRAWKA: Klasy animacji sƒÖ dodawane warunkowo
                    let labelClasses = "block p-4 border-2 rounded-lg cursor-pointer transition-all";
                    if (applyAnimation) {
                        labelClasses += " opacity-0 animate-elegant-fade-in-up";
                    }
                    
                    if (state.showExplanation) {
                        if (isCorrect) labelClasses += " border-green-500 bg-green-50 dark:bg-green-900/30";
                        else if (isWrong) labelClasses += " border-red-500 bg-red-50 dark:bg-red-900/30";
                        else labelClasses += " border-gray-300 dark:border-gray-600 opacity-60";
                    } else {
                        if (isSelected) labelClasses += " border-blue-500 bg-blue-50 dark:bg-blue-900/30";
                        else labelClasses += " border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500";
                    }
                    
                    const animationDelay = applyAnimation ? 0.3 + index * 0.1 : 0;
                    const optionHtml = `
                        <label class="${labelClasses}" style="animation-delay: ${animationDelay}s;">
                            <input type="radio" name="answer" value="${index}" class="sr-only" ${state.showExplanation ? 'disabled' : ''} ${isSelected ? 'checked' : ''}>
                            <div class="flex items-center">
                                <div class="w-5 h-5 rounded-full border-2 mr-4 flex-shrink-0 flex items-center justify-center ${isSelected ? 'border-blue-500' : 'border-gray-400 dark:border-gray-500'}">
                                  ${isSelected ? '<div class="w-2.5 h-2.5 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                <span class="text-gray-700 dark:text-gray-200">${option}</span>
                            </div>
                        </label>`;
                    optionsContainer.innerHTML += optionHtml;
                });
                
                document.querySelectorAll('input[name="answer"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        state.selectedAnswer = e.target.value;
                        checkAnswerBtn.disabled = false;
                        renderQuizView(); // Teraz to wywo≈Çanie jest bezpieczne i nie powt√≥rzy animacji
                    });
                });
                
                if (applyAnimation) {
                    questionEl.classList.remove('opacity-0');
                    questionEl.classList.add('animate-elegant-fade-in-up');
                    optionsEl.classList.remove('opacity-0');
                }

                if (state.showExplanation) {
                    explanationContainer.classList.remove('hidden');
                    const isCorrect = parseInt(state.selectedAnswer) === currentQ.correct;
                    explanationContainer.innerHTML = `
                        <div class="p-4 mt-6 rounded-lg ${isCorrect ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'} animate-elegant-fade-in-up">
                            <h4 class="font-bold mb-2 ${isCorrect ? 'text-green-800 dark:text-green-300' : 'text-red-800 dark:text-red-300'}">${isCorrect ? 'Dobra odpowied≈∫!' : 'Niestety, b≈ÇƒÖd.'}</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">${currentQ.explanation}</p>
                        </div>
                    `;
                    checkAnswerBtn.innerHTML = 'Nastƒôpne pytanie <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>';
                    progressBar.style.width = `${((state.currentQuestionIndex + 1) / state.quizQuestions.length) * 100}%`;
                } else {
                    explanationContainer.classList.add('hidden');
                    explanationContainer.innerHTML = '';
                    checkAnswerBtn.innerHTML = 'Sprawd≈∫ odpowied≈∫ <i data-lucide="chevron-right" class="w-5 h-5 ml-2"></i>';
                }
                checkAnswerBtn.disabled = state.selectedAnswer === null && !state.showExplanation;
                
                const accuracy = state.stats.total > 0 ? Math.round((state.stats.correct / state.stats.total) * 100) : 0;
                overallStatsDisplay.textContent = `${state.stats.correct}/${state.stats.total} (${accuracy}%)`;
                lucide.createIcons();
                
                state.isQuestionNewlyRendered = false; // POPRAWKA: Zresetuj flagƒô po renderowaniu
            }, 50); 
        }

        function renderCompletedView() {
            // ... (bez zmian)
        }

        function renderStatsView() {
            // ... (bez zmian)
        }

        function render() {
            quizView.classList.toggle('hidden', state.currentView !== 'quiz');
            completedView.classList.toggle('hidden', state.currentView !== 'completed');
            statsView.classList.toggle('hidden', state.currentView !== 'stats');

            if (state.currentView === 'quiz') renderQuizView();
            else if (state.currentView === 'completed') renderCompletedView();
            else if (state.currentView === 'stats') renderStatsView();
            
            lucide.createIcons();
        }

        // ### INICJALIZACJA I EVENT LISTENERS ###
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.querySelectorAll('[id^="dark-mode-toggle"]').forEach(btn => btn.addEventListener('click', toggleDarkMode));
            checkAnswerBtn.addEventListener('click', () => { state.showExplanation ? nextQuestion() : handleAnswer(); });
            document.getElementById('new-quiz-btn').addEventListener('click', () => resetQuiz(false));
            document.getElementById('retake-wrong-btn-completed').addEventListener('click', () => resetQuiz(true));
            document.getElementById('retake-wrong-btn-stats').addEventListener('click', () => resetQuiz(true));
            document.getElementById('details-btn-quiz').addEventListener('click', () => { state.currentView = 'stats'; render(); });
            document.getElementById('details-btn-completed').addEventListener('click', () => { state.currentView = 'stats'; render(); });
            document.getElementById('back-to-quiz-btn').addEventListener('click', () => { state.currentView = state.currentQuizResults.length > 0 ? 'quiz' : 'completed'; render(); });
            document.getElementById('download-stats-btn').addEventListener('click', downloadStats);
            document.getElementById('reset-all-data-btn').addEventListener('click', resetAllData);
            
            resetQuiz();
            renderDarkMode();
        });
    </script>
</body>
</html>
</body>
</html>
